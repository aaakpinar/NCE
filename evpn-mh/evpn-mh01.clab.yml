name: evpn-mh01

topology:
  kinds:
    srl:
      image: ghcr.io/nokia/srlinux:23.3.1
    linux:
      image: akpinar/alpine:latest 

  nodes:
    leaf1:
      kind: srl
      type: ixrd2
      startup-config: leaf1.cfg
    leaf2:
      kind: srl
      type: ixrd2
      startup-config: leaf2.cfg
    leaf3:
      kind: srl
      type: ixrd2
      startup-config: leaf3.cfg
    spine1:
      kind: srl
      type: ixrd3
      startup-config: spine1.cfg
    ce1:
      kind: linux
      exec:
        # creating bond with lacp and adding eth1 eth2
        - ip link add bond0 type bond mode 802.3ad
        - ip link set address 00:c1:ab:00:00:11 dev bond0
        - ip addr add 192.168.0.11/24 dev bond0
        - ip link set eth1 down 
        - ip link set eth2 down
        - ip link set eth1 master bond0
        - ip link set eth2 master bond0
        - ip link set eth1 up 
        - ip link set eth2 up  
        - ip link set bond0 up
        
    ce2:
      kind: linux
      exec:
        - ip link set address 00:c1:ab:00:00:21 dev eth1
        - ip link set address 00:c1:ab:00:00:22 dev eth2
        - ip link set address 00:c1:ab:00:00:23 dev eth3
        # creating vrfs to simulate multiple endpoints, basically creating some enthropy to see load-balancing
        - ip link add dev vrf-1 type vrf table 1
        - ip link set dev vrf-1 up
        - ip link set dev eth1 master vrf-1
        - ip link add dev vrf-2 type vrf table 2
        - ip link set dev vrf-2 up
        - ip link set dev eth2 master vrf-2
        - ip link add dev vrf-3 type vrf table 3
        - ip link set dev vrf-3 up
        - ip link set dev eth3 master vrf-3
        # setting ip addresses, each in different vrf
        - ip addr add 192.168.0.21/24 dev eth1
        - ip addr add 192.168.0.22/24 dev eth2
        - ip addr add 192.168.0.23/24 dev eth3

  links:
    # inter-switch links
    - endpoints: ["leaf1:e1-49", "spine1:e1-1"]
    - endpoints: ["leaf2:e1-49", "spine1:e1-2"]
    - endpoints: ["leaf3:e1-49", "spine1:e1-3"]
    # ce links
    - endpoints: ["ce1:eth1", "leaf1:e1-1"]
    - endpoints: ["ce1:eth2", "leaf2:e1-1"]
    - endpoints: ["ce2:eth1", "leaf3:e1-1"]
    - endpoints: ["ce2:eth2", "leaf3:e1-2"]
    - endpoints: ["ce2:eth3", "leaf3:e1-3"]

